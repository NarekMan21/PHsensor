#include <ESP8266WiFi.h>
#include <ESP8266WiFiMulti.h>
#include <ESP8266WebServer.h>
#include <PubSubClient.h>
#include <SoftwareSerial.h>
#include <ArduinoJson.h>
#include <WiFiClientSecure.h>
#include <ESP8266HTTPClient.h>

// ---------- –ù–ê–°–¢–†–û–ô–ö–ò ----------
// WiFi
#define WIFI_SSID1      "Keenetic-1733"
#define WIFI_PASSWORD1  "m2HZ4Ceb"
#define WIFI_SSID2      "COMFAST_F8EB_2G"
#define WIFI_PASSWORD2  "15210625"

// npoint.io –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å (–¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GitHub Pages)
// –ü–æ–ª—É—á–∏—Ç–µ URL –Ω–∞ https://npoint.io –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è endpoint
// –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –æ–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º
#define NPOINT_URL      "https://api.npoint.io/efd090017c044e964c70"
#define NPOINT_UPDATE_INTERVAL 5000  // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ npoint.io (–º—Å)

// MQTT
const char* mqttServer   = "192.168.1.4";
const int   mqttPort     = 1883;
const char* mqttUser     = "mqtttest";
const char* mqttPassword = "21212121";
const char* mqttClientId = "ESP8266SoilNPKPHCTH";

// State-—Ç–æ–ø–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞
const char* topicTempState     = "esp8266/npkphcth/temperature";
const char* topicHumState      = "esp8266/npkphcth/humidity";
const char* topicEcState       = "esp8266/npkphcth/conductivity";
const char* topicPhState       = "esp8266/npkphcth/ph";
const char* topicNState        = "esp8266/npkphcth/nitrogen";
const char* topicPState        = "esp8266/npkphcth/phosphorus";
const char* topicKState        = "esp8266/npkphcth/potassium";

// RS485 –ø–∏–Ω—ã
#define RS485_RX_PIN    D5  // GPIO14
#define RS485_TX_PIN    D6  // GPIO12
#define RE_PIN          D1  // GPIO5
#define DE_PIN          D2  // GPIO4

// Modbus –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
#define SENSOR_ADDRESS       0x01
#define MODBUS_BAUDRATE      4800
#define MODBUS_START_REG     0x0000
#define MODBUS_READ_COUNT    0x0007     
#define MODBUS_RESPONSE_LEN  (3 + 2*MODBUS_READ_COUNT + 2) // 19 –±–∞–π—Ç
#define MODBUS_RESPONSE_TIMEOUT 1000    // –º—Å

// –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã
#define WIFI_RECONNECT_INTERVAL 30000
#define MQTT_RETRY_INTERVAL     5000
#define PUBLISH_INTERVAL        30000

ESP8266WiFiMulti wifiMulti;
ESP8266WebServer server(80);
SoftwareSerial    rs485(RS485_RX_PIN, RS485_TX_PIN);
WiFiClient        wifiClient;
PubSubClient      mqttClient(wifiClient);
WiFiClientSecure  secureClient;  // –î–ª—è HTTPS –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ npoint.io
HTTPClient        httpClient;

struct SensorData {
  float temperature;
  float humidity;
  float conductivity;
  float pH;
  float nitrogen;
  float phosphorus;
  float potassium;
  bool  valid;
} sensorData;

unsigned long lastWifiCheck   = 0;
unsigned long lastPublishTime = 0;
unsigned long lastNpointUpdate = 0;

// CRC-16 Modbus
uint16_t calculateCRC(const uint8_t *data, uint8_t len) {
  uint16_t crc = 0xFFFF;
  for (uint8_t i = 0; i < len; i++) {
    crc ^= data[i];
    for (uint8_t j = 0; j < 8; j++) {
      if (crc & 0x0001) { crc >>= 1; crc ^= 0xA001; }
      else            { crc >>= 1; }
    }
  }
  return crc;
}

// –ß—Ç–µ–Ω–∏–µ —Å—Ä–∞–∑—É 7 —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ (T, H, EC, pH, N, P, K)
bool readAllParameters() {
  static unsigned long lastReadAttempt = 0;
  static uint8_t errorCount = 0;
  
  // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º
  while (rs485.available()) {
    rs485.read();
    yield();
  }
  
  // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ Modbus –∑–∞–ø—Ä–æ—Å–∞
  uint8_t request[8] = {
    SENSOR_ADDRESS, 0x03,
    uint8_t(MODBUS_START_REG >> 8), uint8_t(MODBUS_START_REG & 0xFF),
    uint8_t(MODBUS_READ_COUNT >> 8), uint8_t(MODBUS_READ_COUNT & 0xFF),
    0x00, 0x00
  };
  uint16_t crc = calculateCRC(request, 6);
  request[6] = crc & 0xFF;
  request[7] = crc >> 8;

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
  digitalWrite(DE_PIN, HIGH);
  digitalWrite(RE_PIN, HIGH);
  delay(10); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
  rs485.write(request, 8);
  rs485.flush();
  delay(5); // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –≤ —Ä–µ–∂–∏–º –ø—Ä–∏–µ–º–∞
  digitalWrite(DE_PIN, LOW);
  digitalWrite(RE_PIN, LOW);
  delay(5); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º –ø—Ä–∏–µ–º–∞

  // –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
  uint8_t response[MODBUS_RESPONSE_LEN];
  uint8_t idx = 0;
  unsigned long start = millis();
  
  while (millis() - start < MODBUS_RESPONSE_TIMEOUT && idx < MODBUS_RESPONSE_LEN) {
    if (rs485.available()) {
      response[idx++] = rs485.read();
      start = millis(); // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    }
    yield();
  }
  
  if (idx == 0) {
    errorCount++;
    Serial.printf("‚ùå Modbus: –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –¥–∞—Ç—á–∏–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ %d)\n", errorCount);
    Serial.println("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:");
    Serial.println("   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ RS485 (A+, B-, GND)");
    Serial.println("   - –ü–∏—Ç–∞–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞");
    Serial.println("   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–∏–Ω–æ–≤ DE/RE");
    Serial.println("   - –ê–¥—Ä–µ—Å –¥–∞—Ç—á–∏–∫–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0x01)");
    return false;
  }
  
  if (idx != MODBUS_RESPONSE_LEN) {
    errorCount++;
    Serial.printf("‚ùå Modbus: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–∞–∫–µ—Ç (%d –±–∞–π—Ç –∏–∑ %d, –ø–æ–ø—ã—Ç–∫–∞ %d)\n", idx, MODBUS_RESPONSE_LEN, errorCount);
    Serial.print("   –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –±–∞–π—Ç—ã: ");
    for (uint8_t i = 0; i < idx; i++) {
      Serial.printf("%02X ", response[i]);
    }
    Serial.println();
    
    // –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω–∞—Ö
    if (idx < 3) {
      Serial.println("   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –Ω–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å –¥–∞—Ç—á–∏–∫–∞ –∏–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞");
    } else if (response[0] != SENSOR_ADDRESS) {
      Serial.printf("   –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∞–¥—Ä–µ—Å 0x%02X –≤–º–µ—Å—Ç–æ 0x%02X)\n", response[0], SENSOR_ADDRESS);
    }
    return false;
  }
  
  // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —á—Ç–µ–Ω–∏–∏
  if (errorCount > 0) {
    Serial.printf("‚úÖ –°–≤—è–∑—å —Å –¥–∞—Ç—á–∏–∫–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–±—ã–ª–æ %d –æ—à–∏–±–æ–∫)\n", errorCount);
    errorCount = 0;
  }

  uint16_t respCrc = calculateCRC(response, MODBUS_RESPONSE_LEN - 2);
  if (response[MODBUS_RESPONSE_LEN-2] != (respCrc & 0xFF) ||
      response[MODBUS_RESPONSE_LEN-1] != (respCrc >> 8)) {
    Serial.println("‚ùå Modbus: –Ω–µ–≤–µ—Ä–Ω–∞—è CRC");
    return false;
  }

  uint16_t raw[7];
  for (uint8_t i = 0; i < 7; i++) {
    raw[i] = (response[3 + 2*i] << 8) | response[3 + 2*i + 1];
  }
  sensorData.humidity     = raw[0] / 10.0f;
  sensorData.temperature  = raw[1] / 10.0f;
  sensorData.conductivity = raw[2];
  sensorData.pH           = raw[3] / 10.0f;
  sensorData.nitrogen     = raw[4];
  sensorData.phosphorus   = raw[5];
  sensorData.potassium    = raw[6];
  sensorData.valid        = true;
  
  // –í—ã–≤–æ–¥ –ø–æ–∫–∞–∑–∞–Ω–∏–π –≤ Serial Monitor
  printSensorData();
  
  return true;
}

void setupWiFi() {
  wifiMulti.addAP(WIFI_SSID1, WIFI_PASSWORD1);
  wifiMulti.addAP(WIFI_SSID2, WIFI_PASSWORD2);
  Serial.print("üì∂ WiFi –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ");
  Serial.print(WIFI_SSID1);
  Serial.print(" –∏–ª–∏ ");
  Serial.print(WIFI_SSID2);
  Serial.print("...");
  while (wifiMulti.run() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println();
  Serial.print("‚úÖ WiFi –ø–æ–¥–∫–ª—é—á–µ–Ω! IP –∞–¥—Ä–µ—Å: ");
  Serial.println(WiFi.localIP());
  Serial.printf("   SSID: %s\n", WiFi.SSID().c_str());
  Serial.printf("   –°–∏–ª–∞ —Å–∏–≥–Ω–∞–ª–∞: %d dBm\n", WiFi.RSSI());
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è HTTPS –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ npoint.io
  if (strlen(NPOINT_URL) > 0) {
    secureClient.setInsecure(); // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞)
    Serial.println("üåê –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º (npoint.io) –≤–∫–ª—é—á–µ–Ω");
  }
}

void ensureWiFi() {
  if (millis() - lastWifiCheck > WIFI_RECONNECT_INTERVAL) {
    lastWifiCheck = millis();
    if (wifiMulti.run() != WL_CONNECTED) {
      Serial.println("‚ö†Ô∏è WiFi —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—é—Å—å...");
      setupWiFi();
    }
  }
}

void publishDiscovery() {
  static const struct {
    const char* cfgTopic;
    const char* stateTopic;
    const char* payloadFmt;
  } disco[] = {
    { "homeassistant/sensor/esp_npk_temp/config",   topicTempState,
      "{\"name\":\"Soil Temperature\",\"unique_id\":\"esp_npk_temp\",\"state_topic\":\"%s\",\"unit_of_measurement\":\"¬∞C\",\"device_class\":\"temperature\",\"state_class\":\"measurement\"}" },
    { "homeassistant/sensor/esp_npk_humidity/config",topicHumState,
      "{\"name\":\"Soil Humidity\",\"unique_id\":\"esp_npk_humidity\",\"state_topic\":\"%s\",\"unit_of_measurement\":\"%\",\"device_class\":\"humidity\",\"state_class\":\"measurement\"}" },
    { "homeassistant/sensor/esp_npk_ec/config",      topicEcState,
      "{\"name\":\"Soil EC\",\"unique_id\":\"esp_npk_ec\",\"state_topic\":\"%s\",\"unit_of_measurement\":\"¬µS/cm\",\"state_class\":\"measurement\"}" },
    { "homeassistant/sensor/esp_npk_ph/config",      topicPhState,
      "{\"name\":\"Soil pH\",\"unique_id\":\"esp_npk_ph\",\"state_topic\":\"%s\",\"state_class\":\"measurement\"}" },
    { "homeassistant/sensor/esp_npk_n/config",       topicNState,
      "{\"name\":\"Soil Nitrogen\",\"unique_id\":\"esp_npk_n\",\"state_topic\":\"%s\",\"unit_of_measurement\":\"mg/kg\",\"state_class\":\"measurement\"}" },
    { "homeassistant/sensor/esp_npk_p/config",       topicPState,
      "{\"name\":\"Soil Phosphorus\",\"unique_id\":\"esp_npk_p\",\"state_topic\":\"%s\",\"unit_of_measurement\":\"mg/kg\",\"state_class\":\"measurement\"}" },
    { "homeassistant/sensor/esp_npk_k/config",       topicKState,
      "{\"name\":\"Soil Potassium\",\"unique_id\":\"esp_npk_k\",\"state_topic\":\"%s\",\"unit_of_measurement\":\"mg/kg\",\"state_class\":\"measurement\"}" }
  };
  char buf[256];
  for (auto &d : disco) {
    snprintf(buf, sizeof(buf), d.payloadFmt, d.stateTopic);
    mqttClient.publish(d.cfgTopic, buf, true);
    delay(50);
  }
}

void connectMQTT() {
  static unsigned long lastMqttAttempt = 0;
  static uint8_t mqttErrorCount = 0;
  
  if (!mqttClient.connected()) {
    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    if (millis() - lastMqttAttempt < MQTT_RETRY_INTERVAL) {
      return;
    }
    lastMqttAttempt = millis();
    
    Serial.print("üì° MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ");
    Serial.print(mqttServer);
    Serial.print(":");
    Serial.print(mqttPort);
    Serial.print("...");
    
    if (mqttClient.connect(mqttClientId, mqttUser, mqttPassword)) {
      Serial.println(" OK");
      if (mqttErrorCount > 0) {
        Serial.printf("‚úÖ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω (–±—ã–ª–æ %d –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫)\n", mqttErrorCount);
        mqttErrorCount = 0;
      } else {
        Serial.println("‚úÖ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω");
      }
      Serial.println("   –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Home Assistant...");
      publishDiscovery();
      Serial.println("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Home Assistant –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
    } else {
      mqttErrorCount++;
      int errorCode = mqttClient.state();
      Serial.printf(" ‚ùå FAIL (–∫–æ–¥ –æ—à–∏–±–∫–∏: %d, –ø–æ–ø—ã—Ç–∫–∞ %d)\n", errorCode, mqttErrorCount);
      
      // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ MQTT
      switch(errorCode) {
        case -4: // MQTT_CONNECTION_TIMEOUT
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
          Serial.println("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ MQTT");
          break;
        case -2: // MQTT_CONNECT_FAILED
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è");
          Serial.println("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:");
          Serial.print("   - IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: ");
          Serial.println(mqttServer);
          Serial.print("   - –ü–æ—Ä—Ç: ");
          Serial.println(mqttPort);
          Serial.println("   - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å");
          Serial.println("   - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Å–µ—Ç–∏");
          break;
        case -1: // MQTT_DISCONNECTED
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: –æ—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
          break;
        case 1: // MQTT_CONNECT_BAD_PROTOCOL
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ MQTT");
          break;
        case 2: // MQTT_CONNECT_BAD_CLIENT_ID
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞");
          break;
        case 3: // MQTT_CONNECT_UNAVAILABLE
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
          break;
        case 4: // MQTT_CONNECT_BAD_CREDENTIALS
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
          break;
        case 5: // MQTT_CONNECT_UNAUTHORIZED
          Serial.println("   –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
          break;
        default:
          Serial.println("   –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
      }
      
      delay(1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
    }
  }
}

void publishData() {
  if (!sensorData.valid) {
    Serial.println("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ MQTT");
    return;
  }
  
  Serial.println("üì° –ü—É–±–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ MQTT...");
  mqttClient.publish(topicTempState,     String(sensorData.temperature,1).c_str(), true);
  mqttClient.publish(topicHumState,      String(sensorData.humidity,1).c_str(),    true);
  mqttClient.publish(topicEcState,       String(sensorData.conductivity,0).c_str(),true);
  mqttClient.publish(topicPhState,       String(sensorData.pH,1).c_str(),          true);
  mqttClient.publish(topicNState,        String(sensorData.nitrogen,0).c_str(),    true);
  mqttClient.publish(topicPState,        String(sensorData.phosphorus,0).c_str(),  true);
  mqttClient.publish(topicKState,        String(sensorData.potassium,0).c_str(),   true);
  Serial.println("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –≤ MQTT");
  lastPublishTime = millis();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ npoint.io (–æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å)
void updateNpointData() {
  if (strlen(NPOINT_URL) == 0) {
    return; // –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º –Ω–µ –≤–∫–ª—é—á–µ–Ω
  }
  
  if (!sensorData.valid) {
    return; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  }
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–∞—Ç—á–∏–∫–∞
  DynamicJsonDocument doc(512);
  doc["temperature"] = sensorData.temperature;
  doc["humidity"] = sensorData.humidity;
  doc["conductivity"] = sensorData.conductivity;
  doc["pH"] = sensorData.pH;
  doc["nitrogen"] = sensorData.nitrogen;
  doc["phosphorus"] = sensorData.phosphorus;
  doc["potassium"] = sensorData.potassium;
  doc["valid"] = sensorData.valid;
  doc["timestamp"] = millis();
  doc["ip"] = WiFi.localIP().toString();
  
  String jsonData;
  serializeJson(doc, jsonData);
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ npoint.io —á–µ—Ä–µ–∑ HTTPS
  httpClient.begin(secureClient, NPOINT_URL);
  httpClient.addHeader("Content-Type", "application/json");
  int httpResponseCode = httpClient.POST(jsonData);
  
  if (httpResponseCode > 0) {
    Serial.printf("‚òÅÔ∏è –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ npoint.io (–∫–æ–¥: %d)\n", httpResponseCode);
    String response = httpClient.getString();
    // –ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  } else {
    Serial.printf("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ npoint.io: %d\n", httpResponseCode);
  }
  
  httpClient.end();
  lastNpointUpdate = millis();
}

// –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
void handleRoot() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>PH-7-1 –î–∞—Ç—á–∏–∫</title><style>";
  html += "*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#0f0f23;color:#fff;min-height:100vh}";
  html += ".header{background:linear-gradient(135deg,#03a9f4,#00bcd4);padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.3)}.header h1{font-size:28px;font-weight:600;margin-bottom:5px}.header p{opacity:0.9;font-size:14px}";
  html += ".container{max-width:1200px;margin:30px auto;padding:0 20px}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}";
  html += ".card{background:#1a1a2e;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:transform 0.3s,box-shadow 0.3s}.card:hover{transform:translateY(-5px);box-shadow:0 6px 20px rgba(3,169,244,0.4)}";
  html += ".card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}.card-title{font-size:18px;font-weight:600;color:#03a9f4}.card-icon{font-size:24px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(3,169,244,0.2)}";
  html += ".card-value{font-size:36px;font-weight:700;margin:10px 0;color:#fff}.card-unit{font-size:16px;opacity:0.7;margin-left:5px}.card-footer{font-size:12px;opacity:0.6;margin-top:10px;display:flex;justify-content:space-between}";
  html += ".status{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}.status.online{background:#4caf50;color:#fff}.status.offline{background:#f44336;color:#fff}";
  html += ".footer{text-align:center;padding:20px;opacity:0.6;font-size:12px}@media (max-width:768px){.grid{grid-template-columns:1fr}.card-value{font-size:28px}}</style></head><body>";
  html += "<div class='header'><h1>üå± PH-7-1 –î–∞—Ç—á–∏–∫ –ø–æ—á–≤—ã</h1><p>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ—á–≤—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p></div>";
  html += "<div class='container'><div class='grid'>";
  
  if (sensorData.valid) {
    html += "<div class='card'><div class='card-header'><span class='card-title'>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span><div class='card-icon'>üå°Ô∏è</div></div><div class='card-value'>" + String(sensorData.temperature, 1) + "<span class='card-unit'>¬∞C</span></div><div class='card-footer'><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span><span class='status online'>ONLINE</span></div></div>";
    html += "<div class='card'><div class='card-header'><span class='card-title'>–í–ª–∞–∂–Ω–æ—Å—Ç—å</span><div class='card-icon'>üíß</div></div><div class='card-value'>" + String(sensorData.humidity, 1) + "<span class='card-unit'>%</span></div><div class='card-footer'><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span><span class='status online'>ONLINE</span></div></div>";
    html += "<div class='card'><div class='card-header'><span class='card-title'>–≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å</span><div class='card-icon'>‚ö°</div></div><div class='card-value'>" + String(sensorData.conductivity, 0) + "<span class='card-unit'>¬µS/cm</span></div><div class='card-footer'><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span><span class='status online'>ONLINE</span></div></div>";
    html += "<div class='card'><div class='card-header'><span class='card-title'>pH</span><div class='card-icon'>üß™</div></div><div class='card-value'>" + String(sensorData.pH, 1) + "<span class='card-unit'></span></div><div class='card-footer'><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span><span class='status online'>ONLINE</span></div></div>";
    html += "<div class='card'><div class='card-header'><span class='card-title'>–ê–∑–æ—Ç (N)</span><div class='card-icon'>N</div></div><div class='card-value'>" + String(sensorData.nitrogen, 0) + "<span class='card-unit'>mg/kg</span></div><div class='card-footer'><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span><span class='status online'>ONLINE</span></div></div>";
    html += "<div class='card'><div class='card-header'><span class='card-title'>–§–æ—Å—Ñ–æ—Ä (P)</span><div class='card-icon'>P</div></div><div class='card-value'>" + String(sensorData.phosphorus, 0) + "<span class='card-unit'>mg/kg</span></div><div class='card-footer'><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span><span class='status online'>ONLINE</span></div></div>";
    html += "<div class='card'><div class='card-header'><span class='card-title'>–ö–∞–ª–∏–π (K)</span><div class='card-icon'>K</div></div><div class='card-value'>" + String(sensorData.potassium, 0) + "<span class='card-unit'>mg/kg</span></div><div class='card-footer'><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span><span class='status online'>ONLINE</span></div></div>";
  } else {
    html += "<div class='card'><div class='card-header'><span class='card-title'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span><div class='card-icon'>‚ö†Ô∏è</div></div><div class='card-value'>--<span class='card-unit'></span></div><div class='card-footer'><span>–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞</span><span class='status offline'>OFFLINE</span></div></div>";
  }
  
  html += "</div></div><div class='footer'>ESP8266 PH-7-1 Sensor | IP: " + WiFi.localIP().toString() + "</div>";
  html += "<script>setTimeout(()=>location.reload(),5000);</script></body></html>";
  server.send(200, "text/html; charset=utf-8", html);
}

void handleAPI() {
  // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ CORS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
  server.sendHeader("Access-Control-Allow-Origin", "*");
  server.sendHeader("Access-Control-Allow-Methods", "GET, OPTIONS");
  server.sendHeader("Access-Control-Allow-Headers", "Content-Type");
  
  if (server.method() == HTTP_OPTIONS) {
    server.send(200, "text/plain", "");
    return;
  }
  
  if (!sensorData.valid) {
    server.send(503, "application/json", "{\"error\":\"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\",\"valid\":false}");
    return;
  }
  
  DynamicJsonDocument doc(1024);
  doc["temperature"] = sensorData.temperature;
  doc["humidity"] = sensorData.humidity;
  doc["conductivity"] = sensorData.conductivity;
  doc["pH"] = sensorData.pH;
  doc["nitrogen"] = sensorData.nitrogen;
  doc["phosphorus"] = sensorData.phosphorus;
  doc["potassium"] = sensorData.potassium;
  doc["valid"] = sensorData.valid;
  doc["timestamp"] = millis();
  
  String response;
  serializeJson(doc, response);
  server.send(200, "application/json", response);
}

void setupWebServer() {
  server.on("/", handleRoot);
  server.on("/api", handleAPI);
  server.begin();
  Serial.println("üåê HTTP –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω");
  Serial.print("   –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://");
  Serial.println(WiFi.localIP());
  Serial.print("   JSON API: http://");
  Serial.print(WiFi.localIP());
  Serial.println("/api");
}

void printSensorData() {
  if (sensorData.valid) {
    Serial.println("\n========== –ü–û–ö–ê–ó–ê–ù–ò–Ø –î–ê–¢–ß–ò–ö–ê ==========");
    Serial.printf("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:     %.1f¬∞C\n", sensorData.temperature);
    Serial.printf("–í–ª–∞–∂–Ω–æ—Å—Ç—å:       %.1f%%\n", sensorData.humidity);
    Serial.printf("–≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å: %.0f ¬µS/cm\n", sensorData.conductivity);
    Serial.printf("pH:              %.1f\n", sensorData.pH);
    Serial.printf("–ê–∑–æ—Ç (N):        %.0f mg/kg\n", sensorData.nitrogen);
    Serial.printf("–§–æ—Å—Ñ–æ—Ä (P):      %.0f mg/kg\n", sensorData.phosphorus);
    Serial.printf("–ö–∞–ª–∏–π (K):       %.0f mg/kg\n", sensorData.potassium);
    Serial.println("=======================================\n");
  } else {
    Serial.println("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞");
  }
}

void setup() {
  Serial.begin(115200);
  delay(10);
  Serial.println("\n\n=======================================");
  Serial.println("    PH-7-1 –î–∞—Ç—á–∏–∫ –ø–æ—á–≤—ã ESP8266");
  Serial.println("=======================================\n");
  
  pinMode(DE_PIN, OUTPUT);
  pinMode(RE_PIN, OUTPUT);
  digitalWrite(DE_PIN, LOW);
  digitalWrite(RE_PIN, LOW);
  rs485.begin(MODBUS_BAUDRATE);
  Serial.println("‚úÖ RS485 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
  Serial.printf("   –°–∫–æ—Ä–æ—Å—Ç—å: %d –±–æ–¥\n", MODBUS_BAUDRATE);
  Serial.printf("   RX: GPIO%d (D%d)\n", RS485_RX_PIN, RS485_RX_PIN);
  Serial.printf("   TX: GPIO%d (D%d)\n", RS485_TX_PIN, RS485_TX_PIN);
  Serial.printf("   DE: GPIO%d (D%d)\n", DE_PIN, DE_PIN);
  Serial.printf("   RE: GPIO%d (D%d)\n", RE_PIN, RE_PIN);
  Serial.printf("   –ê–¥—Ä–µ—Å –¥–∞—Ç—á–∏–∫–∞: 0x%02X\n", SENSOR_ADDRESS);

  setupWiFi();
  mqttClient.setServer(mqttServer, mqttPort);
  setupWebServer();
  sensorData.valid = false;
  lastPublishTime = millis() - PUBLISH_INTERVAL;
  
  Serial.println("\n–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞...\n");
}

void loop() {
  ensureWiFi();
  connectMQTT();
  mqttClient.loop();
  server.handleClient();

  // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞ (–∫–∞–∂–¥—ã–µ 100–º—Å)
  static unsigned long lastReadTime = 0;
  if (millis() - lastReadTime >= 100) {
    lastReadTime = millis();
    sensorData.valid = readAllParameters();
  }

  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ MQTT —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
  if (millis() - lastPublishTime >= PUBLISH_INTERVAL) {
    publishData();
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ npoint.io (–æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å)
  if (strlen(NPOINT_URL) > 0 && millis() - lastNpointUpdate >= NPOINT_UPDATE_INTERVAL) {
    updateNpointData();
  }
  
  delay(10); // –£–º–µ–Ω—å—à–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏
}
